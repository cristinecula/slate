<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title><%= current_page.data.title || "API Documentation" %></title>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>    
    <%= javascript_include_tag  "bower/iframe-resizer/js/iframeResizer.contentWindow.min" %>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <style type="text/css">
      body,html {
        margin: 0;
      }
      body {
        color: white;
        font-family: Roboto, sans-serif;
        padding: 20px;
      }

      pre.console {      
        max-height: 400px;
        overflow: auto;
        overflow-x: hidden;
        margin: 0;
        background: hsla(0, 0%, 0%, 0.5);
        box-shadow: 2px 2px 3px rgba(0,0,0,.2);
      }

      pre.console div:nth-child(even) {    
        background: rgba(255,255,255,.1);
      }
    </style>
  </head>

  <body>  
    <button class="run">Run snippet</button>
    <pre class="console" style="display:none"></pre>

    <script src="https://widgetic.com/sdk/sdk.dev.js" type="text/javascript"></script>
    <script type="text/javascript">
    var persist = function(key) {
      return function(value) {
        localStorage[key] = JSON.stringify(value)
        return value
      }
    }

    var retrieve = function(key) {
      try {
        return JSON.parse(localStorage[key])        
      } catch(e) {
        return false;
      }
    }

    var Widgetic = Blogvio;

    Widgetic.init('554de62709c7e23f7f8b4567_4bgmtqx250aoookowwook40gk0408s4gs8w0o4o8o0cc4cscc8', window.location.origin + '/examples/proxy.html');

    $('.console').append($('<div>').text('Console:'))
    var log = function(what) {
      $('.console').append($('<div>').text(JSON.stringify(what, null, '  ')))
    }

    var oldLog = console.log

    console.log = function() {
      log.apply(window, arguments);
      oldLog.apply(console, arguments);
    }
    var clearConsole = function() {
      $('.console div').remove();
      $('.console').append($('<div>').text('Console:'))
    }

    var showConsole = function() {
      $('.console').show();
    }

    var doInteractiveAuth = function() {
      var deferred = Widgetic.Aye.defer()

      var $button = $('.login-button');
      if($button.length === 0) {
        $button = $('<button class="login-button">Login with Widgetic!</button>');
      }

      var hideButton = function() {
        $button.off('click').hide();
      }

      $button.off('click').on('click', function() {
        clearConsole();
        Widgetic.auth()
          .then(deferred.resolve)
          .fail(deferred.reject)
      });  

      $('body').append($button);
      return deferred.promise;
    }

    function run() {
      Widgetic.auth(false)
        .fail(doInteractiveAuth)
        .then(clearConsole)
        .then(showConsole)
        .then(window.snippet)
        .fail(run)
    };

    $('.run').on('click', run);
    </script>
    <%= yield %>
  </body>
</html>
